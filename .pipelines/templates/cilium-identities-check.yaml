parameters:
  - name: ciliumVersionTag
    type: string

steps:
  - script: |
      ns=`kubectl get ns | grep cilium-test | awk '{print $1}'`
      echo "##vso[task.setvariable variable=ciliumNamespace]$ns"
    retryCountOnTaskFailure: 3
    name: "nsCapture"
    displayName: "Capture Connectivity Test Namespace"

  - script: |
      set -e
      echo "validate pod IP assignment and check systemd-networkd restart"
      kubectl get pod -owide -A
      if [ "${{ parameters.ciliumVersionTag }}" = "cilium-nightly-pipeline" ]; then
        echo "Check cilium identities in $(ciliumNamespace) namepsace during nightly run"
        echo "expect the identities to be deleted when the namespace is deleted"
        kubectl get ciliumidentity | grep cilium-test
      fi
      make test-validate-state
      echo "delete cilium connectivity test resources and re-validate state"
      kubectl delete ns $(ciliumNamespace)
      kubectl get pod -owide -A
      make test-validate-state
    name: "validatePods"
    displayName: "Validate Pods"

  - script: |
      if [ "${{ parameters.ciliumVersionTag }}" = "cilium-nightly-pipeline" ]; then
        kubectl get pod -owide -n $(ciliumNamespace)
        echo "wait for pod and cilium identity deletion in $(ciliumNamespace) namespace"
        while true; do
          pods=$(kubectl get pods -n $(ciliumNamespace) --no-headers=true 2>/dev/null)
          if [[ -z "$pods" ]]; then
            echo "No pods found"
              break
          fi
          sleep 2s
        done
        sleep 20s
        echo "Verify cilium identities are deleted from $(ciliumNamespace)"
        checkIdentity="$(kubectl get ciliumidentity -o json | grep cilium-test | jq -e 'length == 0')"
        if [[ -n $checkIdentity ]]; then
          echo "##[error]Cilium Identities still present in $(ciliumNamespace) namespace"
          exit 1
        else
          printf -- "Identities deleted from $(ciliumNamespace) namespace\n"
        fi
      else
        echo "skip cilium identities check for PR pipeline"
      fi
    name: "CiliumIdentities"
    displayName: "Verify Cilium Identities Deletion"
