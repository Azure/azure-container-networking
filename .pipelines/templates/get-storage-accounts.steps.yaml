parameters:

- name: STORAGE_ACCOUNT_SERVICE_CONNECTION
  type: string

- name: varNameStorageAccountList
  type: string
  default: None

steps:
## Storage Account Resource Query
- task: AzureCLI@2
  displayName: "Get Storage Account Resources"
  inputs:
    azureSubscription: ${{ parameters.STORAGE_ACCOUNT_SERVICE_CONNECTION }}
    scriptType: bash
    scriptLocation: inlineScript
    addSpnToEnvironment: true
    inlineScript: |
      set -eu
      [[ -n $SYSTEM_DEBUG ]] && [[ $SYSTEM_DEBUG =~ $IS_TRUE ]] && set -x || set +x

      # Query for Test Storage Accounts
      R_QUERY="[?type == 'Microsoft.Storage/storageAccounts']"
      R_LIST=$(az resource list \
        --query "$R_QUERY" \
        --tag PipelineResource="$SYSTEM_DEFINITIONID" -o json)

      R_LIST_LENGTH=$(echo "$R_LIST" | jq -rc '. | length')

      # Export the available storage account list..
      #  uses custom variable naming if specified.
      if [[ -n $VARNAME_SA_LIST ]] && \
        ! [[ $VARNAME_SA_LIST =~ ^[N|n][O|o][N|n][E|e]$ ]]; then
        echo >&2 "##vso[task.setvariable variable=${VARNAME_SA_LIST};issecret=true;]${R_LIST}"
        echo >&2 "##vso[task.setvariable variable=${VARNAME_SA_LIST}_LENGTH;issecret=true]${R_LIST_LENGTH}"
      else
        echo >&2 "##vso[task.setvariable variable=SA_LIST;issecret=true;]$R_LIST"
        echo >&2 "##vso[task.setvariable variable=SA_LIST_LENGTH;issecret=true;]$R_LIST_LENGTH"
      fi
  env:
    VARNAME_SA_LIST: '${{ parameters.varNameStorageAccountList }}'
