parameters:
- name: source_path
  description: "The path (absolute or relative to $working_directory) to the desired source folder. If the folder does not exist, a new one will be created. Any matching files will be overwritten."
  type: string
- name: source_dockerfile
  description: "The file name of the source dockerfile. Omit path."
  type: string

- name: target_path
  description: "The path (absolute or relative to $working_directory) to the desired target folder. If the folder does not exist, a new one will be created. Any matching files will be overwritten."
  type: string
- name: target_dockerfile
  description: "The new file name of the dockerfile. Omit path."
  type: string
  default: 'Dockerfile'

- name: working_directory
  description: "The directory to perform the operations."
  type: string
  default: '$(Build.SourcesDirectory)'

- name: replace_references
  description: "If this is set to true, this module will rename references to the moved Dockerfile to the new $target_dockerfile. This is a dumb sed replace. Set with care."
  type: bool
  default: false

- name: replace_path
  description: "The directory for which to search for references to the old dockerfile name. Replce will default to $target_path if not provided."
  type: string
  default: ''

- name: topic
  description: "Appends a provided topic string to the display name. Need not be unique. Defaults to empty string."
  type: string
  default: ''


steps:
- bash: |
    set -e; [[ -n $DEBUG ]] && [[ $DEBUG =~ ^[T|t]rue$ ]] && set -x

    mv "$SOURCE_REL_PATH"/"$SOURCE_DOCKERFILE" "$TARGET_REL_PATH"/"$TARGET_DOCKERFILE"
    if [[ -n $REFERENCE_REPLACE ]] && [[ $REFERENCE_REPLACE =~ ^[T|t]rue$ ]]; then
      sed -i "s|$SOURCE_DOCKERFILE|$TARGET_DOCKERFILE|g" $(grep -rl "$REPLACE_PATH")
    fi
    find "$TARGET_REL_PATH" -type f -depth 0 -name '*Dockerfile' ! -wholename "$TARGET_REL_PATH"/"$TARGET_DOCKERFILE" -delete
  workingDirectory: $(ACR_DIR)
  ${{ if parameters.topic }}:
    displayName: "Move Dockerfile to OneBranch Approved Naming Format - ${{ parameters.topic }}"
  ${{ else }}:
    displayName: "Move Dockerfile to OneBranch Approved Naming Format"
  env: 
    REFERENCE_REPLACE: ${{ parameters.replace_references }}
    REPLACE_PATH: ${{ coalesce(parameters.replace_path, parameters.target_path) }}
    SOURCE_REL_PATH: ${{ parameters.source_path }}
    TARGET_REL_PATH: ${{ parameters.target_path }}
    SOURCE_DOCKERFILE: ${{ parameters.source_dockerfile }}
    TARGET_DOCKERFILE: ${{ parameters.target_dockerfile }}
