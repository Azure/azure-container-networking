
steps:
      
- task: AzureCLI@2
  name: build
  displayName: "[Output] SC Environment App Details"
  inputs:
    azureSubscription: $(ACN_TEST_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    addSpnToEnvironment: true
    inlineScript: |
      set -e
      [[ -n $SYSTEM_DEBUG ]] && [[ $SYSTEM_DEBUG =~ $IS_TRUE ]] && set -x || set +x

      # App OID
      SP_APP_OID=$(az ad sp show --id "$servicePrincipalId" | jq -rc '.id') 
      echo >&2 "##vso[task.setvariable variable=ACNCI_BUILD_SP_APP_OID;isoutput=true;]$SP_APP_OID"
      # Get Subscription ID.
      SUBSCRIPTION_ID=$(az account show | jq -rc '.id')
      SUBSCRIPTION_NAME=$(az account show | jq -rc '.name')
      TENANT_ID=$(az account show | jq -rc '.tenantId')
      echo >&2 "##vso[task.setvariable variable=ACNCI_BUILD_SUBSCRIPTION_ID;isoutput=true;issecret=true]$SUBSCRIPTION_ID"
      echo >&2 "##vso[task.setvariable variable=ACNCI_BUILD_SUBSCRIPTION_NAME;isoutput=true;issecret=true]$SUBSCRIPTION_NAME"
      echo >&2 "##vso[task.setvariable variable=ACNCI_BUILD_TENANT_ID;isoutput=true;issecret=true]$TENANT_ID"


## Resource Groups ##
- bash: |
    UNIQUE_ID=`tr -dc '0-9a-z' < /dev/urandom | head -c${1:-7}`
    echo >&2 "##vso[task.setvariable variable=LOCAL_ACNCI_UNIQUE_ID]$UNIQUE_ID"
  displayName: "[Infra] Generate Unique ID"

- template: get-resources.steps.yaml
  parameters:
    resourceType: resourcegroups
    serviceConnection: $(ACN_TEST_SERVICE_CONNECTION)
    inputs: 
      buildTagDefinitionIdKey: $(ACNCI_BUILDTAG_DEFINITIONID)
      buildTagCreatedByAppIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)

- template: create-or-update-resource.steps.yaml
  parameters:
    serviceConnection: $(ACN_TEST_SERVICE_CONNECTION)
    resourceType: resourcegroups
    createCondition: |
      and(succeeded(),
          or(not(variables.OUT_RESULT_LENGTH),
             lt(variables.OUT_RESULT_LENGTH, variables.ACNCI_POOL_SIZE)))
    updateCondition: False
    inputs:
      resourceGroupList: $(OUT_RESULT)
      resourceGroupCount: $(OUT_RESULT_LENGTH)
      resourceGroupName: $(ACNCI_RG_PREFIX)$(LOCAL_ACNCI_UNIQUE_ID)
      resourceGroupLocation: $(ACNCI_RG_LOCATION)
      buildTagDefinitionIdKey: $(ACNCI_BUILDTAG_DEFINITIONID)
      buildTagCreatedByAppIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)
      buildTagCreatedByBuildIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)  

- task: AzureCLI@2
  name: resourcegroups
  displayName: "[Output] Build Resource Group"
  inputs:
    azureSubscription: $(ACN_TEST_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    addSpnToEnvironment: true
    inlineScript: |
      set -e
      [[ -n $SYSTEM_DEBUG ]] && [[ $SYSTEM_DEBUG =~ $IS_TRUE ]] && set -x || set +x

      RANDOM_SELECT=`tr -dc '1-9' < /dev/urandom | head -c${1:-7}`
      IDX=$(( "$RANDOM_SELECT" % "$INFRA_RG_LENGTH" ))
      RG_DATA=$(echo "$INFRA_RG_LIST" | jq --argjson IDX "$IDX" -rc '.[$IDX]')
      RG_NAME=$(echo "$RG_DATA" | jq -rc '.name')
      RG_ID=$(echo "$RG_DATA" | jq -rc '.id')

      echo >&2 "##vso[task.setvariable variable=ACNCI_BUILD_RESOURCEGROUP;isoutput=true;]$RG_NAME"
      echo >&2 "##vso[task.setvariable variable=ACNCI_BUILD_RESOURCEGROUP_LOCATION;isoutput=true;]$ACNCI_RG_LOCATION"
      echo >&2 "##vso[task.setvariable variable=ACNCI_BUILD_RESOURCEGROUP_ID;isoutput=true;]$RG_ID"
  env:
    ACNCI_RG_LOCATION: $(ACNCI_RG_LOCATION)
    INFRA_RG_LIST: $(OUT_RESULT)
    INFRA_RG_LENGTH: $(OUT_RESULT_LENGTH)
    

## MI Service Connection

#        SERVICECONNECTION_PRINCIPALID: ${{ parameters.inputs.serviceConnectionPrincipalId }}
#        SUBSCRIPTION_ID: ${{ parameters.inputs.subscriptionId }}
#        SUBSCRIPTION_NAME: ${{ parameters.inputs.subscriptionName }}
#        SERVICECONNECTION_TENANTID: ${{ parameters.inputs.tenantId }}
#        SERVICECONNECTION_NAME: ${{ parameters.inputs.serviceConnectionName }}
#
#- template: create-or-update-resource.steps.yaml
#  parameters:
#    resourceType: serviceconnection
#    serviceConnection: $(ACN_TEST_SERVICE_CONNECTION)
#    createCondition: |
#      and(succeeded(),
#          or(not(variables.OUT_RESULT_LENGTH),
#             eq(variables.OUT_RESULT_LENGTH, 'null'),
#             lt(variables.OUT_RESULT_LENGTH, 1)))
#    updateCondition: False
#    inputs:
#      serviceConnectionName: $(managedidentity.ACNCI_MANAGEDIDENTITY_NAME)-serviceconnection
#      serviceConnectionPrincipalId: $(managedidentity.ACNCI_MANAGEDIDENTITY_OBJECTID)
#      subscriptionId: $(build.ACNCI_BUILD_SUBSCRIPTION_ID)
#      subscriptionName: $(build.ACNCI_BUILD_SUBSCRIPTION_NAME)
#      tenantId: $(build.ACNCI_BUILD_TENANT_ID)
#      buildTagDefinitionIdKey: $(ACNCI_BUILDTAG_DEFINITIONID)
#      buildTagCreatedByAppIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)
#      buildTagCreatedByBuildIdKey: $(ACNCI_BUILDTAG_CREATEDBYBUILDID)
#

## MI Role Definition ##

#- template: get-resources.steps.yaml
  #parameters:
    #resourceType: roledefinition
    #serviceConnection: $(ACN_TEST_SERVICE_CONNECTION)
    #inputs: 
      #roleName: $(ACNCI_BUILDUSER_ROLE_NAME)
      #roleDefinitionFileLocation: ./azure-container-networking/.pipelines/templates/mi-build-role.json
      #subscriptionId: $(build.ACNCI_BUILD_SUBSCRIPTION_ID)
      #buildTagDefinitionIdKey: $(ACNCI_BUILDTAG_DEFINITIONID)
      #buildTagCreatedByAppIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)
#
#- template: create-or-update-resource.steps.yaml
  #parameters:
    #serviceConnection: $(ACN_TEST_SERVICE_CONNECTION)
    #resourceType: roledefinition
    #refreshAfterCreation: True 
    #createCondition: |
      #and(succeeded(),
          #or(not(variables.OUT_RESULT_LENGTH),
             #lt(variables.OUT_RESULT_LENGTH, 1)))
    #updateCondition: |
      #and(succeeded(),
          #gt(variables.OUT_RESULT_LENGTH, 0))
    #inputs:
      #roleName: $(ACNCI_BUILDUSER_ROLE_NAME)
      #roleDefinitionJson: $(OUT_RESULT)
      #roleDefinitionFileLocation: ./azure-container-networking/.pipelines/templates/mi-build-role.json
      #resourceGroupId: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP)
      #subscriptionId: $(build.ACNCI_BUILD_SUBSCRIPTION_ID)
      #buildTagDefinitionIdKey: $(ACNCI_BUILDTAG_DEFINITIONID)
      #buildTagCreatedByAppIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)
      #buildTagCreatedByBuildIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)  
#
#
### Provision MI Roles
#
#- template: get-resources.steps.yaml
  #parameters:
    #resourceType: roleassignments
    #serviceConnection: $(ACN_TEST_SERVICE_CONNECTION)
    #inputs: 
      #roleName: $(ACNCI_BUILDUSER_ROLE_NAME)
      #managedIdentityObjectId: $(build.ACNCI_BUILD_SP_APP_OID)
      #resourceGroupName: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP)
      #buildTagDefinitionIdKey: $(ACNCI_BUILDTAG_DEFINITIONID)
      #buildTagCreatedByAppIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)
#
#- template: create-or-update-resource.steps.yaml
  #parameters:
    #serviceConnection: $(ACN_TEST_SERVICE_CONNECTION)
    #resourceType: roleassignments
    #createCondition: |
      #and(succeeded(),
          #or(not(variables.OUT_RESULT_LENGTH),
             #eq(variables.OUT_RESULT, 'null'),
             #lt(variables.OUT_RESULT_LENGTH, 1)))
    #updateCondition: False
    #inputs:
      #roleName: $(ACNCI_BUILDUSER_ROLE_NAME)
      #managedIdentityObjectId: $(build.ACNCI_BUILD_SP_APP_OID)
      #resourceGroupId: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP_ID)
      #resourceGroupName: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP)
      #buildTagDefinitionIdKey: $(ACNCI_BUILDTAG_DEFINITIONID)
      #buildTagCreatedByAppIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)
      #buildTagCreatedByBuildIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)  

## Enable Build User Service Connection Access

- template: get-resources.steps.yaml
  parameters:
    resourceType: serviceconnection
    serviceConnection: $(ACN_TEST_SERVICE_CONNECTION)
    inputs: 
      serviceConnectionId: $(ACNCI_BUILDUSER_SERVICECONNECTION_ID)
      resourceGroupName: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP)
      buildTagDefinitionIdKey: $(ACNCI_BUILDTAG_DEFINITIONID)
      buildTagCreatedByAppIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)

- task: AzureCLI@2
  name: serviceconnection
  displayName: "[Output] Build User ServiceConnection Details"
  inputs:
    azureSubscription: $(ACN_TEST_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    addSpnToEnvironment: true
    inlineScript: |
      set -e
      [[ -n $SYSTEM_DEBUG ]] && [[ $SYSTEM_DEBUG =~ $IS_TRUE ]] && set -x || set +x

      # Select MI to use
      RANDOM_SELECT=`tr -dc '1-9' < /dev/urandom | head -c${1:-7}`
      IDX=$(( "$RANDOM_SELECT" % "$SC_LIST_LENGTH" ))
      SC_DATA=$(echo "$SC_LIST" | jq --argjson IDX "$IDX" -rc '.[$IDX]')

      SC_ID=$(echo "$SC_DATA" | jq -rc '.id')
      echo >&2 "##vso[task.setvariable variable=ACNCI_SERVICECONNECTION_ID;isoutput=true]$SC_ID"
      SC_NAME=$(echo "$SC_DATA" | jq -rc '.name')
      echo >&2 "##vso[task.setvariable variable=ACNCI_SERVICECONNECTION_NAME;isoutput=true]$SC_NAME"
      SC_APP_OID=$(echo "$SC_DATA" | jq -rc '.data.spnObjectId')
      echo >&2 "##vso[task.setvariable variable=ACNCI_BUILDUSER_SERVICECONNECTION_APP_OID;isoutput=true]$SC_APP_OID"
      SC_APPID=$(echo "$SC_DATA" | jq -rc '.authorization.parameters.serviceprincipalid')
      echo >&2 "##vso[task.setvariable variable=ACNCI_BUILDUSER_SERVICECONNECTION_CLIENTID;isoutput=true]$SC_APPID"
  env:
    SC_LIST: $(OUT_RESULT)
    SC_LIST_LENGTH: $(OUT_RESULT_LENGTH)

# storage accounts

- template: get-resources.steps.yaml
  parameters:
    resourceType: storageaccounts
    serviceConnection: $(ACN_TEST_SERVICE_CONNECTION)
    inputs: 
      resourceGroupName: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP)
      buildTagDefinitionIdKey: $(ACNCI_BUILDTAG_DEFINITIONID)
      buildTagCreatedByAppIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)
      buildTagCreatedByBuildIdKey: $(ACNCI_BUILDTAG_CREATEDBYBUILDID)  

- template: create-or-update-resource.steps.yaml
  parameters:
    serviceConnection: $(ACN_TEST_SERVICE_CONNECTION)
    resourceType: storageaccounts
    refreshAfterCreation: True 
    createCondition: |
      and(succeeded(),
          or(not(variables.OUT_RESULT_LENGTH),
             lt(variables.OUT_RESULT_LENGTH, 1)))
    updateCondition: False
    inputs:
      storageAccountName: '$(ACNCI_SA_PREFIX)$(LOCAL_ACNCI_UNIQUE_ID)'
      storageAccountLocation: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP_LOCATION)
      resourceGroupName: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP)
      managedIdentityResourceId: $(managedidentity.ACNCI_MANAGEDIDENTITY_ID) 
      buildTagDefinitionIdKey: $(ACNCI_BUILDTAG_DEFINITIONID)
      buildTagCreatedByAppIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)
      buildTagCreatedByBuildIdKey: $(ACNCI_BUILDTAG_CREATEDBYBUILDID)  
      buildTagBuildUserAppId: $(ACNCI_BUILDTAG_BUILDUSER_APPID)

- task: AzureCLI@2
  name: artifact_storage
  displayName: "[Output] Storage Account Data"
  inputs:
    azureSubscription: $(ACN_TEST_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    addSpnToEnvironment: true
    inlineScript: |
      set -e
      [[ -n $SYSTEM_DEBUG ]] && [[ $SYSTEM_DEBUG =~ $IS_TRUE ]] && set -x || set +x

      SA_RANDOM_SELECT=`tr -dc '1-9' < /dev/urandom | head -c${1:-7}`
      R_INDEX=$(( "$SA_RANDOM_SELECT" % "$SA_LIST_LENGTH" ))
      # Make a random selection from the pool
      SA_DATA=$(echo "$SA_LIST" | jq --argjson IDX "$R_INDEX" -rc '.[$IDX]')
      if (( "$SA_LIST_LENGTH" > 0 )); then
        # Azure Resource ID
        SA_ID=$(echo "$SA_DATA" | jq -r '.id')
        echo >&2 "##vso[task.setvariable variable=ACNCI_STORAGEACCOUNT_ID;isoutput=true]$SA_ID"
        # Azure Resource Name
        SA_NAME=$(echo "$SA_DATA" | jq -r '.name')
        echo >&2 "##vso[task.setvariable variable=ACNCI_STORAGEACCOUNT_NAME;isoutput=true]$SA_NAME"
        # Storage Account Subscription
        SA_SUBSCRIPTION=$(echo "$SA_DATA" | jq -r '.subscription')
        echo >&2 "##vso[task.setvariable variable=ACNCI_STORAGEACCOUNT_SUBSCRIPTION;isoutput=true]$SA_SUBSCRIPTION"
        # Service Connection
        echo >&2 "##vso[task.setvariable variable=ACNCI_STORAGEACCOUNT_SERVICECONNECTION;isoutput=true]$SA_SERVICE_CONN"
        # Storage Account Resource Group
        SA_RG=$(echo "$SA_DATA" | jq -r '.resourceGroup')
        echo >&2 "##vso[task.setvariable variable=ACNCI_STORAGEACCOUNT_RESOURCEGROUP;isoutput=true]$SA_RG"
        # Storage Account Location
        SA_LOCATION=$(echo "$SA_DATA" | jq -r '.location')
        echo >&2 "##vso[task.setvariable variable=ACNCI_STORAGEACCOUNT_LOCATION;isoutput=true]$SA_LOCATION"
        # Current Build Storage Data
        echo >&2 "##vso[task.setvariable variable=ACNCI_STORAGEACCOUNT_CONTAINER_NAME;isoutput=true]$STORAGECONTAINER_NAME"
        echo >&2 "##vso[task.setvariable variable=ACNCI_STORAGEACCOUNT_BLOB_PATH;isoutput=true]$STORAGEBLOB_PATH"
        # - Local Use Only -
        # SA Object
        echo >&2 "##vso[task.setvariable variable=ACNCI_STORAGEACCOUNT]$SA_DATA"
        echo $SA_DATA
      else
        echo >&2 "##[error]No storage accounts available for use."
        exit 1
      fi
  env:
    SA_LIST: $(OUT_RESULT)
    SA_LIST_LENGTH: $(OUT_RESULT_LENGTH)
    SA_SERVICE_CONN: $(ACN_TEST_SERVICE_CONNECTION)
    STORAGECONTAINER_NAME: "azure-container-networking-pr"
    STORAGEBLOB_PATH: $(Build.BuildId)/$(System.JobAttempt)

- task: AzureCLI@2
  name: build_storage
  displayName: "[Provision] Establish Build Storage"
  inputs:
    azureSubscription: $(ACN_TEST_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -e
      [[ -n $SYSTEM_DEBUG ]] && [[ $SYSTEM_DEBUG =~ $IS_TRUE ]] && set -x || set +x

      az storage container create \
        --account-name "$STORAGEACCOUNT_NAME" \
        --resource-group "$RESOURCEGROUP_NAME" \
        --name "$STORAGECONTAINER_NAME" \
        --auth-mode login || echo >&2 "##[info]Storage container provisioned."

      echo "hold" | az storage blob upload \
        --data @- \
        --name "$STORAGEBLOB_PATH/.created" \
        --container-name "$STORAGECONTAINER_NAME" \
        --account-name "$STORAGEACCOUNT_NAME" \
        --overwrite \
        --auth-mode login
  env:
    RESOURCEGROUP_NAME: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP)
    STORAGEACCOUNT_NAME: $(artifact_storage.ACNCI_STORAGEACCOUNT_NAME)
    STORAGECONTAINER_NAME: $(artifact_storage.ACNCI_STORAGEACCOUNT_CONTAINER_NAME)
    STORAGEBLOB_PATH: $(serviceconnection.ACNCI_BUILDUSER_SERVICECONNECTION_CLIENTID)/$(Build.BuildId)/$(System.JobAttempt)


## Managed Identity ##

#- template: get-resources.steps.yaml
  #parameters:
    #resourceType: managedidentity
    #serviceConnection: $(ACN_TEST_SERVICE_CONNECTION)
    #inputs: 
      #resourceGroupName: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP)
      #buildTagDefinitionIdKey: $(ACNCI_BUILDTAG_DEFINITIONID)
      #buildTagCreatedByAppIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)
#
#- template: create-or-update-resource.steps.yaml
  #parameters:
    #serviceConnection: $(ACN_TEST_SERVICE_CONNECTION)
    #resourceType: managedidentity
    #refreshAfterCreation: True 
    #createCondition: |
      #and(succeeded(),
          #or(not(variables.OUT_RESULT_LENGTH),
             #eq(variables.OUT_RESULT_LENGTH, 'null'),
             #lt(variables.OUT_RESULT_LENGTH, 1)))
    #updateCondition: False
    #inputs:
      #managedIdentityList: $(OUT_RESULT)
      #managedIdentityCount: $(OUT_RESULT_LENGTH)
      #managedIdentityName: '$(ACNCI_MANAGEDIDENTITY_PREFIX)$(LOCAL_ACNCI_UNIQUE_ID)-$(resourcegroups.ACNCI_BUILD_RESOURCEGROUP_LOCATION)'
      #managedIdentityLocation: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP_LOCATION)
      #resourceGroupName: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP)
      #buildTagDefinitionIdKey: $(ACNCI_BUILDTAG_DEFINITIONID)
      #buildTagCreatedByAppIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)
      #buildTagCreatedByBuildIdKey: $(ACNCI_BUILDTAG_CREATEDBYBUILDID)
#
#- task: AzureCLI@2
  #name: managedidentity
  #displayName: "[Output] Build User ManagedIdentity Details"
  #inputs:
    #azureSubscription: $(ACN_TEST_SERVICE_CONNECTION)
    #scriptType: bash
    #scriptLocation: inlineScript
    #addSpnToEnvironment: true
    #inlineScript: |
      #set -e
      #[[ -n $SYSTEM_DEBUG ]] && [[ $SYSTEM_DEBUG =~ $IS_TRUE ]] && set -x || set +x
#
      ## Select MI to use
      #RANDOM_SELECT=`tr -dc '1-9' < /dev/urandom | head -c${1:-7}`
      #IDX=$(( "$RANDOM_SELECT" % "$MI_LIST_LENGTH" ))
      #MI_DATA=$(echo "$MI_LIST" | jq --argjson IDX "$IDX" -rc '.[$IDX]')
#
      #MI_ID=$(echo "$MI_DATA" | jq -r '.id')
      #echo >&2 "##vso[task.setvariable variable=ACNCI_MANAGEDIDENTITY_ID;isoutput=true]$MI_ID"
      #MI_PRINCIPALID=$(echo "$MI_DATA" | jq -r '.principalId')
      #echo >&2 "##vso[task.setvariable variable=ACNCI_MANAGEDIDENTITY_OBJECTID;isoutput=true]$MI_PRINCIPALID"
      #MI_APPID=$(echo "$MI_DATA" | jq -r '.clientId')
      #echo >&2 "##vso[task.setvariable variable=ACNCI_MANAGEDIDENTITY_APPID;isoutput=true]$MI_APPID"
      #MI_NAME=$(echo "$MI_DATA" | jq -r '.name')
      #echo >&2 "##vso[task.setvariable variable=ACNCI_MANAGEDIDENTITY_NAME;isoutput=true]$MI_NAME"
  #env:
    #ACNCI_BUILD_RESOURCEGROUP: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP)
    #MI_LIST: $(OUT_RESULT)
    #MI_LIST_LENGTH: $(OUT_RESULT_LENGTH)

- task: AzureCLI@2
  displayName: "[Test] Blob Access Should Fail"
  continueOnError: true
  inputs:
    azureSubscription: $(ACN_TEST_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    addSpnToEnvironment: true
    inlineScript: |
      set -x
      az login --service-principal --username "$SP_ID" --tenant "$SP_TENANT"
      az storage blob download \
        --auth-mode login \
        --container-name "$STORAGECONTAINER_NAME" \
        --account-name "$STORAGEACCOUNT_NAME" \
        --name "$STORAGEBLOB_PATH/.created" \
        --file output
      cat ./output
  env:
    AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)
    STORAGEACCOUNT_NAME: $(artifact_storage.ACNCI_STORAGEACCOUNT_NAME)
    STORAGECONTAINER_NAME: $(artifact_storage.ACNCI_STORAGEACCOUNT_CONTAINER_NAME)
    STORAGEBLOB_PATH: $(serviceconnection.ACNCI_BUILDUSER_SERVICECONNECTION_CLIENTID)/$(Build.BuildId)/$(System.JobAttempt)
    SP_ID: $(serviceconnection.ACNCI_BUILDUSER_SERVICECONNECTION_CLIENTID)
    SP_TENANT: $(build.ACNCI_BUILD_TENANT_ID) 

- task: AzureCLI@2
  displayName: "[Provision] Build User Access Permissions"
  continueOnError: true
  inputs:
    azureSubscription: $(ACN_TEST_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    addSpnToEnvironment: true
    inlineScript: |
      set -e
      [[ -n $SYSTEM_DEBUG ]] && [[ $SYSTEM_DEBUG =~ $IS_TRUE ]] && set -x || set +x
      az upgrade --yes

      CONDITION="(@Resource[Microsoft.Storage/storageAccounts/blobServices/containers:Name] stringEquals '$STORAGECONTAINER_NAME') AND (@Resource[Microsoft.Storage/storageAccounts/blobServices/containers/blobs:Name] stringStartsWith '$EXPECTED_STORAGEBLOB_PREFIX')"
      az role assignment create \
        --role "Storage Blob Data Contributor" \
        --assignee-object-id "$SP_ID" \
        --assignee-principal-type ServicePrincipal \
        --scope "$STORAGEACCOUNT_ID/blobServices/default/containers/$STORAGECONTAINER_NAME" \
        --condition "$CONDITION" \
        --condition-version '2.0'
  env:
    STORAGEACCOUNT_ID: $(artifact_storage.ACNCI_STORAGEACCOUNT_ID)
    STORAGEACCOUNT_NAME: $(artifact_storage.ACNCI_STORAGEACCOUNT_NAME)
    STORAGECONTAINER_NAME: $(artifact_storage.ACNCI_STORAGEACCOUNT_CONTAINER_NAME)
    EXPECTED_STORAGEBLOB_PREFIX: $(serviceconnection.ACNCI_BUILDUSER_SERVICECONNECTION_CLIENTID)/$(Build.BuildId)
    SP_ID: $(serviceconnection.ACNCI_BUILDUSER_SERVICECONNECTION_CLIENTID)
    SP_TENANT: $(build.ACNCI_BUILD_TENANT_ID) 

- task: AzureCLI@2
  displayName: "[Test] Blob Access Should Succeed"
  continueOnError: true
  inputs:
    azureSubscription: $(ACN_TEST_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    addSpnToEnvironment: true
    inlineScript: |
      set -xe
      az login --service-principal --username "$SP_ID" --tenant "$SP_TENANT"
      az storage blob download \
        --auth-mode login \
        --account-name "$STORAGEACCOUNT_NAME" \
        --container-name "$STORAGECONTAINER_NAME" \
        --name "$STORAGEBLOB_PATH/.created" \
        --file output
      cat ./output
  env:
    STORAGEACCOUNT_NAME: $(artifact_storage.ACNCI_STORAGEACCOUNT_NAME)
    STORAGECONTAINER_NAME: $(artifact_storage.ACNCI_STORAGEACCOUNT_CONTAINER_NAME)
    STORAGEBLOB_PATH: $(serviceconnection.ACNCI_BUILDUSER_SERVICECONNECTION_CLIENTID)/$(Build.BuildId)/$(System.JobAttempt)
    SP_ID: $(serviceconnection.ACNCI_SERVICECONNECTION_CLIENTID)
    SP_TENANT: $(build.ACNCI_BUILD_TENANT_ID) 

#- template: create-or-update-resource.steps.yaml
  #parameters:
    #serviceConnection: $(ACN_TEST_SERVICE_CONNECTION)
    #resourceType: managedidentity
    #refreshAfterCreation: True 
    #createCondition: False
    #updateCondition: succeeded()
    #inputs:
      #managedIdentityName: $(managedidentity.ACNCI_MANAGEDIDENTITY_NAME)
      #resourceGroupName: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP)
      #buildTagDefinitionIdKey: $(ACNCI_BUILDTAG_DEFINITIONID)
      #buildTagCreatedByAppIdKey: $(ACNCI_BUILDTAG_CREATEDBYAPPID)
      #buildTagCreatedByBuildIdKey: $(ACNCI_BUILDTAG_CREATEDBYBUILDID)
#
#- task: AzureCLI@2
  #displayName: "[Test] Blob Access"
  #continueOnError: true
  #inputs:
    #azureSubscription: $(ACN_TEST_SERVICE_CONNECTION)
    #scriptType: bash
    #scriptLocation: inlineScript
    #addSpnToEnvironment: true
    #inlineScript: |
      #set +x
      #az login --service-principal --username "$MI_NAME" --tenant "$MI_TENANT"
      #az storage blob download --auth-mode login --container-name "$STORAGECONTAINER_NAME" --account-name "$STORAGEACCOUNT_NAME" --name "$STORAGEBLOB_PATH/.created" --file output
      #cat ./output
  #env:
    #RESOURCEGROUP_NAME: $(resourcegroups.ACNCI_BUILD_RESOURCEGROUP)
    #STORAGEACCOUNT_NAME: $(artifact_storage.ACNCI_STORAGEACCOUNT_NAME)
    #STORAGECONTAINER_NAME: $(artifact_storage.ACNCI_STORAGEACCOUNT_CONTAINER_NAME)
    #MANAGEDIDENTITY_OBJECTID: $(managedidentity.ACNCI_MANAGEDIDENTITY_OBJECTID)
    #STORAGEBLOB_PATH: $(Build.BuildId)/$(System.JobAttempt)
    #MI_NAME: $(managedidentity.ACNCI_MANAGEDIDENTITY_NAME)
    #MI_TENANT: $(build.ACNCI_BUILD_TENANT_ID) 
