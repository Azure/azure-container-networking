parameters:
  clusterName: ""

steps:
  - script: |
      # Forked to ensure that testing is consistent and does not break d/t k8s's CI
      git clone https://github.com/jpayne3506/kubernetes.git
    name: "Checkout_k8s"
    displayName: "Checkout Kubernetes"
  - script: |
      set -ex
      cd kubernetes
      ./build/run.sh make WHAT=test/e2e/e2e.test
      echo "##vso[task.setvariable variable=E2E;]$(pwd)/_output/dockerized/bin/linux/amd64/"
      # Windows e2e tests require the use of unique images
      curl https://raw.githubusercontent.com/kubernetes-sigs/windows-testing/master/images/image-repo-list-private-registry -o repo_list
      echo "##vso[task.setvariable variable=KUBE_TEST_REPO_LIST;]$(pwd)/repo_list"
      # We need Ginkgo CLI for e2e testing. k8s has make command for that
      make ginkgo
      echo "##vso[task.setvariable variable=GINKGODIR;]$(pwd)/_output/bin"
    name: "setup"
    displayName: "Setup Environment"
  - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        # hostNetwork | SCTP Connectivity - Not supported
        # Networking Granular - Datapath testing
        # kubernetes api - Tests k8s api calls
        set -ex
        make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}-$(make revision)
        kubectl get pods -A
        $(GINKGODIR)/ginkgo --procs=4 \
        $(E2E)/e2e.test -- \
        --provider=skeleton \
        --ginkgo.focus="\[sig-network\].Networking.Granular|\[sig-network\](.*)kubernetes.api" \
        --ginkgo.skip="Feature:SCTPConnectivity|LinuxOnly|\[sig-network\](.*)hostNetwork" \
        --ginkgo.v \
        --node-os-distro="windows" \
        --kubeconfig=$HOME/.kube/config
    name: "Datapath_Test"
    displayName: "Windows Datapath Test"
