parameters:
  clusterName: "cilium-scale"

steps:
  - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        set -ex
        make -C ./hack/aks azcfg AZCLI=az REGION=$(LOCATION)
        make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
        echo "Gradually scale up cluster to 1000 Nodes"
        echo "Scaling to 100 nodes"
        az aks nodepool scale --name nodepool1 --cluster-name ${{ parameters.clusterName }} --resource-group ${{ parameters.clusterName }} --node-count 100
    name: "ScaleUp100"
    displayName: "Scale up to 100 Nodes"
  
  - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        set -ex
        make -C ./hack/aks azcfg AZCLI=az REGION=$(LOCATION)
        make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
        echo "Scaling to 200 nodes"
        az aks nodepool scale --name nodepool1 --cluster-name ${{ parameters.clusterName }} --resource-group ${{ parameters.clusterName }} --node-count 200
    name: "ScaleUp200"
    displayName: "Scale up to 200 Nodes"

  - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        set -ex
        make -C ./hack/aks azcfg AZCLI=az REGION=$(LOCATION)
        make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
        echo "Scaling to 300 nodes"
        az aks nodepool scale --name nodepool1 --cluster-name ${{ parameters.clusterName }} --resource-group ${{ parameters.clusterName }} --node-count 300
    name: "ScaleUp300"
    displayName: "Scale up to 300 Nodes"

  - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        set -ex
        make -C ./hack/aks azcfg AZCLI=az REGION=$(LOCATION)
        make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
        echo "Scaling to 400 nodes"
        az aks nodepool scale --name nodepool1 --cluster-name ${{ parameters.clusterName }} --resource-group ${{ parameters.clusterName }} --node-count 400
    name: "ScaleUp400"
    displayName: "Scale up to 400 Nodes"

  - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        set -ex
        make -C ./hack/aks azcfg AZCLI=az REGION=$(LOCATION)
        make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
        echo "Scaling to 500 nodes"
        az aks nodepool scale --name nodepool1 --cluster-name ${{ parameters.clusterName }} --resource-group ${{ parameters.clusterName }} --node-count 500
    name: "ScaleUp500"
    displayName: "Scale up to 500 Nodes"

  - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        set -ex
        make -C ./hack/aks azcfg AZCLI=az REGION=$(LOCATION)
        make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
        echo "Scaling to 600 nodes"
        az aks nodepool scale --name nodepool1 --cluster-name ${{ parameters.clusterName }} --resource-group ${{ parameters.clusterName }} --node-count 600
    name: "ScaleUp600"
    displayName: "Scale up to 600 Nodes"

  - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        set -ex
        make -C ./hack/aks azcfg AZCLI=az REGION=$(LOCATION)
        make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
        echo "Scaling to 700 nodes"
        az aks nodepool scale --name nodepool1 --cluster-name ${{ parameters.clusterName }} --resource-group ${{ parameters.clusterName }} --node-count 700
    name: "ScaleUp700"
    displayName: "Scale up to 700 Nodes"

  - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        set -ex
        make -C ./hack/aks azcfg AZCLI=az REGION=$(LOCATION)
        make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
        echo "Scaling to 800 nodes"
        az aks nodepool scale --name nodepool1 --cluster-name ${{ parameters.clusterName }} --resource-group ${{ parameters.clusterName }} --node-count 800
    name: "ScaleUp800"
    displayName: "Scale up to 800 Nodes"
  
  - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        set -ex
        make -C ./hack/aks azcfg AZCLI=az REGION=$(LOCATION)
        make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
        echo "Scaling to 900 nodes"
        az aks nodepool scale --name nodepool1 --cluster-name ${{ parameters.clusterName }} --resource-group ${{ parameters.clusterName }} --node-count 900
    name: "ScaleUp900"
    displayName: "Scale up to 900 Nodes"

  - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        set -ex
        make -C ./hack/aks azcfg AZCLI=az REGION=$(LOCATION)
        make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
        echo "Scaling to 1000 nodes"
        az aks nodepool scale --name nodepool1 --cluster-name ${{ parameters.clusterName }} --resource-group ${{ parameters.clusterName }} --node-count 1000
    name: "ScaleUp1000"
    displayName: "Scale up to 1000 Nodes"
