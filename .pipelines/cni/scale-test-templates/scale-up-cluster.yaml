parameters:
  clusterName: "cilium-scale"

steps:
  - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        set -ex
        make -C ./hack/aks azcfg AZCLI=az REGION=$(LOCATION)
        make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
        echo "Gradually scale up cluster to 1000 Nodes"
        echo "Scaling to 300 nodes"
        az aks nodepool scale --name nodepool1 --cluster-name ${{ parameters.clusterName }} --resource-group ${{ parameters.clusterName }} --node-count 300
    name: "ScaleUp300"
    displayName: "Scale up to 300 Nodes"
  
   - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
      set -ex
      make -C ./hack/aks azcfg AZCLI=az REGION=$(LOCATION)
      make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
      echo "Scaling to 600 nodes"
      az aks nodepool scale --name nodepool1 --cluster-name ${{ parameters.clusterName }} --resource-group ${{ parameters.clusterName }} --node-count 600
    name: "ScaleUp600"
    displayName: "Scale up to 600 Nodes"

   - task: AzureCLI@1
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
      set -ex
      make -C ./hack/aks azcfg AZCLI=az REGION=$(LOCATION)
      make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
      echo "Scaling to 1000 nodes"
      az aks nodepool scale --name nodepool1 --cluster-name ${{ parameters.clusterName }} --resource-group ${{ parameters.clusterName }} --node-count 1000
    name: "ScaleUp1000"
    displayName: "Scale up to 1000 Nodes"
