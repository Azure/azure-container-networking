steps:
  - task: AzureCLI@2
    name: throughput_setup
    displayName: "Setup netperf"
    inputs:
      azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        az aks get-credentials --resource-group ${RESOURCE_GROUP} --name ${CLUSTER}
        kubectl apply -f hack/manifests/k8s-netperf.yaml

        ARTIFACT_DIR=$(Build.ArtifactStagingDirectory)/throughput
        mkdir -p $ARTIFACT_DIR
        echo $ARTIFACT_DIR

  # - template: k8s-netperf-test-template.yaml
  #   parameters:
  #     resourceGroup: "$(RESOURCE_GROUP)"
  #     clusterName: "$(CLUSTER)"
  #     name: "none"
  #     numDeployments: 0
  #     numReplicasPerDeployment: 0
  #     numPolicies: 0
  #     numUnappliedPolicies: 0
  #     numServices: 0
  # - template: k8s-netperf-test-template.yaml
  #   parameters:
  #     resourceGroup: "$(RESOURCE_GROUP)"
  #     clusterName: "$(CLUSTER)"
  #     name: "pods"
  #     numDeployments: "$(NUM_REAL_DEPLOYMENTS_NETPOL)" # 2
  #     numReplicasPerDeployment: "$(NUM_REAL_REPLICAS_NETPOL)" # 30
  #     numPolicies: 0
  #     numUnappliedPolicies: 0
  #     numServices: 0
  - template: k8s-netperf-test-template.yaml
    parameters:
      resourceGroup: "$(RESOURCE_GROUP)"
      clusterName: "$(CLUSTER)"
      name: "policies"
      numDeployments: "$(NUM_REAL_DEPLOYMENTS_NETPOL)" # 2
      numReplicasPerDeployment: "$(NUM_REAL_REPLICAS_NETPOL)" # 30
      numPolicies: "$(APPLIED_NETPOL)" # 20
      numUnappliedPolicies: "$(UNAPPLIED_NETPOL)" # 40
      numServices: 0
  # - template: k8s-netperf-test-template.yaml
  #   parameters:
  #     resourceGroup: "$(RESOURCE_GROUP)"
  #     clusterName: "$(CLUSTER)"
  #     name: "services"
  #     numDeployments: "$(NUM_REAL_DEPLOYMENTS_NETPOL)" # 2
  #     numReplicasPerDeployment: "$(NUM_REAL_REPLICAS_NETPOL)" # 30
  #     numPolicies: 0
  #     numUnappliedPolicies: 0
  #     numServices: "$(NUM_REAL_SVC_NETPOL)" # 30
  # - template: k8s-netperf-test-template.yaml
  #   parameters:
  #     resourceGroup: "$(RESOURCE_GROUP)"
  #     clusterName: "$(CLUSTER)"
  #     name: "policies_and_services"
  #     numDeployments: "$(NUM_REAL_DEPLOYMENTS_NETPOL)" # 2
  #     numReplicasPerDeployment: "$(NUM_REAL_REPLICAS_NETPOL)" # 30
  #     numPolicies: "$(APPLIED_NETPOL)" # 20
  #     numUnappliedPolicies: "$(UNAPPLIED_NETPOL)" # 40
  #     numServices: "$(NUM_REAL_SVC_NETPOL)" # 30

  - task: PublishBuildArtifacts@1
    name: throughput_artifacts
    inputs:
      artifactName: $(CLUSTER)-throughput
      pathtoPublish: "$(Build.ArtifactStagingDirectory)/$(CLUSTER)/"
    condition: always()
    displayName: "Publish Artifacts"
  
  # - task: AzureCLI@2
  #   name: throughput_cleanup
  #   displayName: "Cleanup netperf resources"
  #   inputs:
  #     azureSubscription: $(TEST_SUB_SERVICE_CONNECTION)
  #     scriptLocation: "inlineScript"
  #     scriptType: "bash"
  #     addSpnToEnvironment: true
  #     inlineScript: |                
  #       az aks get-credentials --resource-group ${RESOURCE_GROUP} --name ${CLUSTER}
  #       kubectl delete deployment netperf-pod
  #       kubectl delete ds netperf-pod
  #       kubectl delete ds netperf-host
  #       kubectl delete svc netperf-server
  #   condition: always()
