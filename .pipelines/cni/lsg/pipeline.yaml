parameters:
- name: KernelVersion
  type: string
  default: 1000
- name: KernelType
  type: string
  default: linux-azure-edge
- name: ProposedRepoVersion
  type: string
  default: proposed

pr: none
trigger: none

# Placeholder for when we want to enable automatic queuing of pipeline from LSG's pipeline.
# Fully functional to queue off of ACN PR Pipeline
# resources:
#   pipelines:
#   - pipeline: ACN-PR # Name of the pipeline resource.
#     source: \Custom\Networking\ContainerNetworking\Azure Container Networking PR # The name of the pipeline referenced by this pipeline resource.
#     trigger: true # Run CNI | LSG Integration pipeline when any run of LSG defined pipeline completes


stages:
  - stage: setup
    displayName: Setup
    jobs:
      - job: env
        displayName: Setup
        pool:
          name: "$(BUILD_POOL_NAME_DEFAULT)"
        steps:
          - script: |
              echo "Setting up environment"
              go version
              echo "##vso[task.setvariable variable=commitID;isOutput=true]$(echo $(make revision)-$(date "+%d%H%M"))"
              echo "##vso[task.setvariable variable=cnsVersion;isOutput=true]$(CNS_VERSION)"
              echo "##vso[task.setvariable variable=cniVersion;isOutput=true]$(CNI_VERSION)"

              echo "------"
              echo Queued by $(Build.QueuedBy)
              echo "Runtime Variables passed"
              echo "KernelType : $(KernelType)"
              echo "KernelVersion : $(KernelVersion)"
              echo "ProposedRepoVersion : $(ProposedRepoVersion)"
              echo "------"
              echo "Runtime Parameters passed"
              echo "KernelType : ${{ parameters.KernelType }}"
              echo "KernelVersion : ${{ parameters.KernelVersion }}"
              echo "ProposedRepoVersion : ${{ parameters.ProposedRepoVersion }}"
            name: "SetEnvVars"
            displayName: "Set Environment Variables"
            condition: always()

  - template: lsg-cni-intergration-template.yaml
    parameters:
      name: linux_overlay
      clusterType: overlay-byocni-up
      clusterName: "kup-overlay"
      nodeCount: 2
      vmSize: Standard_B2ms
      arch: amd64
      cni: cniv2
      test: var

  - template: lsg-cni-intergration-template.yaml
    parameters:
      name: linux_over_par
      clusterType: overlay-byocni-up
      clusterName: "kup-over-par"
      nodeCount: 2
      vmSize: Standard_B2ms
      arch: amd64
      cni: cniv2
      test: par
      KernelType : ${{ parameters.KernelType }}
      KernelVersion : ${{ parameters.KernelVersion }}
      ProposedRepoVersion : ${{ parameters.ProposedRepoVersion }}

  - stage: delete_resources
    displayName: "Delete Resources"
    pool:
      name: "$(BUILD_POOL_NAME_DEFAULT)"
    condition: always()
    dependsOn:
      - linux_overlay
      - linux_over_par
      - setup
    variables:
      commitID: $[ stagedependencies.setup.env.outputs['SetEnvVars.commitID'] ]
    jobs:
      - job: delete
        displayName: Delete Cluster
        pool:
          name: "$(BUILD_POOL_NAME_DEFAULT)"
        strategy:
          matrix:
            linux_overlay:
              name: linux_overlay
              clusterName: "kup-overlay"
            linux_over_par:
              name: linux_over_par
              clusterName: "kup-over-par"
        steps:
          - template: ../../templates/delete-cluster.yaml
            parameters:
              name: $(name)
              clusterName: $(clusterName)-$(commitID)
              region: $(LOCATION)
