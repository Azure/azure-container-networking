parameters:
  name: ""
  clusterName: ""
  os: ""

steps:
  - bash: |
      go version
      go env
      mkdir -p '$(GOBIN)'
      mkdir -p '$(GOPATH)/pkg'
      mkdir -p '$(modulePath)'
      echo '##vso[task.prependpath]$(GOBIN)'
      echo '##vso[task.prependpath]$(GOROOT)/bin'
    name: "GoEnv"
    displayName: "Set up the Go environment"

  - task: KubectlInstaller@0
    inputs:
      kubectlVersion: latest

  - task: AzureCLI@2
    inputs:
      azureSubscription: $(BUILD_VALIDATIONS_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        set -e
        make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${{ parameters.clusterName }}
    name: "kubeconfig"
    displayName: "Set Kubeconfig"

  # Linux-specific steps
  - ${{ if eq(parameters.os, 'linux') }}:
    - script: |
        echo "Start Integration Tests on Overlay Cluster - Linux"
        kubectl get po -owide -A
        sudo -E env "PATH=$PATH" make test-load \
          SCALE_UP=32 OS_TYPE=linux CNI_TYPE=stateless VALIDATE_STATEFILE=true VALIDATE_V4OVERLAY=true \
          INSTALL_CNS=true INSTALL_AZURE_VNET_STATELESS=true CLEANUP=true \
          AZURE_IPAM_VERSION=$(make azure-ipam-version) CNS_VERSION=$(make cns-version) CNI_VERSION=$(make cni-version)
      name: "LinuxOverlayControlPlaneScaleTests"
      displayName: "Linux v4Overlay ControlPlane Scale Tests"
      retryCountOnTaskFailure: 2

    - script: |
        echo "Validate telemetry sidecar binary is deployed on Linux nodes"
        for node in $(kubectl get nodes -o jsonpath='{.items[?(@.status.nodeInfo.operatingSystem=="linux")].metadata.name}'); do
          echo "Checking telemetry sidecar on node: $node"
          kubectl debug node/$node -it --image=alpine -- cat /host/opt/cni/bin/azure-cni-telemetry-sidecar > /dev/null 2>&1 && echo "Telemetry sidecar binary found on $node" || echo "WARNING: Telemetry sidecar binary NOT found on $node"
        done
      name: "ValidateTelemetrySidecarLinux"
      displayName: "Validate Telemetry Sidecar Deployment - Linux"
      continueOnError: true

    - task: AzureCLI@2
      inputs:
        azureSubscription: $(BUILD_VALIDATIONS_SERVICE_CONNECTION)
        scriptLocation: "inlineScript"
        scriptType: "bash"
        addSpnToEnvironment: true
        inlineScript: |
          set -e
          kubectl get po -owide -A
          clusterName=${{ parameters.clusterName }}
          echo "Restarting Linux nodes"
          for val in $(az vmss list -g MC_${clusterName}_${clusterName}_$(REGION_AKS_CLUSTER_TEST) --query "[?contains(name, 'nodepool1')].name" -o tsv); do
            make -C ./hack/aks restart-vmss AZCLI=az CLUSTER=${clusterName} REGION=$(REGION_AKS_CLUSTER_TEST) VMSS_NAME=${val}
          done
      displayName: "Restart Linux Nodes"

    - task: AzureCLI@2
      inputs:
        azureSubscription: $(BUILD_VALIDATIONS_SERVICE_CONNECTION)
        scriptLocation: "inlineScript"
        scriptType: "bash"
        addSpnToEnvironment: true
        inlineScript: |
          cd test/integration/load
          clusterName=${{ parameters.clusterName }}
          make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${clusterName}
          make -C ./hack/aks azcfg AZCLI=az REGION=$(REGION_AKS_CLUSTER_TEST)
          kubectl get pods -owide -A
          echo "Validating Linux Node Restart"
          CNI_TYPE=stateless RESTART_CASE=true OS_TYPE=linux go test -timeout 30m -tags load -run ^TestValidateState$
      displayName: "Validate Linux Node Restart"
      retryCountOnTaskFailure: 3

    - script: |
        echo "Run wireserver and metadata connectivity Tests"
        bash test/network/wireserver_metadata_test.sh
      retryCountOnTaskFailure: 3
      name: "WireserverMetadataConnectivityTestsLinux"
      displayName: "Run Wireserver and Metadata Connectivity Tests - Linux"

    - script: |
        echo "Waiting for Linux nodes to be Ready..."
        kubectl wait --for=condition=Ready nodes -l kubernetes.io/os=linux --timeout=300s
        echo "Linux Datapath Test (Goldpinger)"
        cd test/integration/datapath
        sudo -E env "PATH=$PATH" go test -count=1 datapath_linux_test.go -timeout 10m -tags=connection,integration -run ^TestDatapathLinux$
      name: "LinuxDatapathTests"
      displayName: "Linux Datapath Tests (Goldpinger)"
      retryCountOnTaskFailure: 3

  # Windows-specific steps
  - ${{ if eq(parameters.os, 'windows') }}:
    - script: |
        nodeList=`kubectl get node -owide | grep Windows | awk '{print $1}'`
        for node in $nodeList; do
          taint=`kubectl describe node $node | grep Taints | awk '{print $2}'`
          if [ $taint == "node.cloudprovider.kubernetes.io/uninitialized=true:NoSchedule" ]; then
              kubectl taint nodes $node node.cloudprovider.kubernetes.io/uninitialized=true:NoSchedule-
          fi
        done
        sudo -E env "PATH=$PATH" make test-load \
          SCALE_UP=32 OS_TYPE=windows CNI_TYPE=stateless VALIDATE_STATEFILE=true VALIDATE_V4OVERLAY=true \
          INSTALL_CNS=true INSTALL_AZURE_VNET_STATELESS=true CLEANUP=true \
          AZURE_IPAM_VERSION=$(make azure-ipam-version) CNS_VERSION=$(make cns-version) CNI_VERSION=$(make cni-version)
      name: "WindowsOverlayControlPlaneScaleTests"
      displayName: "Windows v4Overlay ControlPlane Scale Tests"
      retryCountOnTaskFailure: 2

    - script: |
        echo "Validate telemetry sidecar binary is deployed on Windows nodes"
        for node in $(kubectl get nodes -l kubernetes.io/os=windows -o jsonpath='{.items[*].metadata.name}'); do
          echo "Checking telemetry sidecar on Windows node: $node"
          kubectl get pods -n kube-system -l k8s-app=azure-cns-win -o jsonpath='{.items[*].spec.initContainers[*].args}' | grep -q "azure-cni-telemetry-sidecar" && echo "Telemetry sidecar init container configured for Windows" || echo "WARNING: Telemetry sidecar init container NOT configured for Windows"
        done
      name: "ValidateTelemetrySidecarWindows"
      displayName: "Validate Telemetry Sidecar Deployment - Windows"
      continueOnError: true

    - task: AzureCLI@2
      inputs:
        azureSubscription: $(BUILD_VALIDATIONS_SERVICE_CONNECTION)
        scriptLocation: "inlineScript"
        scriptType: "bash"
        addSpnToEnvironment: true
        inlineScript: |
          set -e
          kubectl get po -owide -A
          clusterName=${{ parameters.clusterName }}
          echo "Restarting Windows nodes"
          for val in $(az vmss list -g MC_${clusterName}_${clusterName}_$(REGION_AKS_CLUSTER_TEST) --query "[?contains(name, 'npwin')].name" -o tsv); do
            make -C ./hack/aks restart-vmss AZCLI=az CLUSTER=${clusterName} REGION=$(REGION_AKS_CLUSTER_TEST) VMSS_NAME=${val}
          done
      displayName: "Restart Windows Nodes"

    - task: AzureCLI@2
      inputs:
        azureSubscription: $(BUILD_VALIDATIONS_SERVICE_CONNECTION)
        scriptLocation: "inlineScript"
        scriptType: "bash"
        addSpnToEnvironment: true
        inlineScript: |
          cd test/integration/load
          clusterName=${{ parameters.clusterName }}
          make -C ./hack/aks set-kubeconf AZCLI=az CLUSTER=${clusterName}
          make -C ./hack/aks azcfg AZCLI=az REGION=$(REGION_AKS_CLUSTER_TEST)
          kubectl get pods -owide -A
          echo "Validating Windows Node Restart"
          CNI_TYPE=stateless RESTART_CASE=true OS_TYPE=windows go test -timeout 30m -tags load -run ^TestValidateState$
      displayName: "Validate Windows Node Restart"
      retryCountOnTaskFailure: 3

    - script: |
        echo "Run wireserver and metadata connectivity Tests"
        bash test/network/wireserver_metadata_test.sh
      retryCountOnTaskFailure: 3
      name: "WireserverMetadataConnectivityTestsWindows"
      displayName: "Run Wireserver and Metadata Connectivity Tests - Windows"

    - script: |
        echo "Waiting for Windows nodes to be Ready..."
        kubectl wait --for=condition=Ready nodes -l kubernetes.io/os=windows --timeout=300s
        echo "IPv4 Overlay DataPath Test"
        cd test/integration/datapath
        sudo -E env "PATH=$PATH" go test -count=1 datapath_windows_test.go -timeout 10m -tags=connection,integration -restartKubeproxy true -run ^TestDatapathWin$
      name: "WindowsV4OverlayDatapathTests"
      displayName: "Windows v4Overlay Datapath Tests"
      retryCountOnTaskFailure: 3
