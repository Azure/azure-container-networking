parameters:
  name: ""
  clusterName: ""
  scaleup: ""

steps:
  - task: AzureCLI@2
    displayName: 'Update IP configs'
    env:
      SCALE_UP: ${{ coalesce(parameters.scaleup, 32) }}
      RESOURCE_GROUP: "MC_${{ parameters.clusterName }}_${{ parameters.clusterName }}_$(REGION_AKS_CLUSTER_TEST)"
    inputs:
      azureSubscription: $(BUILD_VALIDATIONS_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
          set -e
          SECONDARY_IP_COUNT=$((SCALE_UP * 2)) \
          go run $(Build.SourcesDirectory)/test/integration/cilium-nodesubnet/ipconfigupdate.go

  - task: KubectlInstaller@0
    inputs:
      kubectlVersion: latest

  - task: AzureCLI@2
    env:
      AZCLI: az
      CLUSTER: ${{ parameters.clusterName }}
    inputs:
      azureSubscription: $(BUILD_VALIDATIONS_SERVICE_CONNECTION)
      scriptLocation: "inlineScript"
      scriptType: "bash"
      addSpnToEnvironment: true
      inlineScript: |
        set -e
        make -C ./hack/aks set-kubeconf
        ls -lah
        pwd
        kubectl cluster-info
        kubectl get po -owide -A
        echo "install Cilium ${CILIUM_VERSION_TAG}"
        export DIR=$(echo ${CILIUM_VERSION_TAG#v} | cut -d. -f1,2)
        echo "installing files from ${DIR}"
        echo "deploy Cilium ConfigMap"
        kubectl apply -f test/integration/manifests/cilium/v${DIR}/cilium-config/cilium-config.yaml
        # Passes Cilium image to daemonset and deployment
        kubectl apply -f test/integration/manifests/cilium/v${DIR}/cilium-agent/files
        kubectl apply -f test/integration/manifests/cilium/v${DIR}/cilium-operator/files

        envsubst '${CILIUM_VERSION_TAG},${CILIUM_IMAGE_REGISTRY}' < test/integration/manifests/cilium/v${DIR}/cilium-agent/templates/daemonset.yaml | kubectl apply -f -
        envsubst '${CILIUM_VERSION_TAG},${CILIUM_IMAGE_REGISTRY}' < test/integration/manifests/cilium/v${DIR}/cilium-operator/templates/deployment.yaml | kubectl apply -f -
        kubectl get po -owide -A
    displayName: "Install Cilium"

  - template: ../../templates/cilium-cli.yaml

  - script: |
      echo "Start Nodesubnet E2E Tests"
      kubectl get po -owide -A
      sudo -E env "PATH=$PATH" make test-load AZURE_IPAM_VERSION=$(make azure-ipam-version) CNS_VERSION=$(make cns-version)
    retryCountOnTaskFailure: 3
    displayName: "Run NodeSubnet E2E"
    env:
      SCALE_UP: 32
      OS_TYPE: linux
      VALIDATE_STATEFILE: true
      INSTALL_CNS: true
      INSTALL_CNS_NODESUBNET: true
      CLEANUP: true

  - template: ../../templates/cilium-tests.yaml
    parameters:
      clusterName: ${{ parameters.clusterName }}
      scaleup: ${{ parameters.scaleup }}
