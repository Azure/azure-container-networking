parameters:
  name: ""
  arch: ""

steps:
- task: Docker@2
  displayName: Login
  inputs:
    containerRegistry: $(ACR_SERVICE_CONNECTION)
    command: 'login'
    addPipelineData: false

- powershell: |
    Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
    choco install make which git
  name: win_env
  displayName: Install dependencies

- powershell: |
    $tag = make ${{ parameters.name }}-version
    echo "using tag $tag"
    . .\build\scripts\windows.ps1; ( ${{ parameters.name }}-image windows-${{ parameters.arch }}-$tag )
  name: image_build
  displayName: Image Build
  retryCountOnTaskFailure: 3

- powershell: |
    $registry = "acnpublic.azurecr.io"
    $tag = make ${{ parameters.name }}-version
    docker push $registry/azure-${{ parameters.name }}:windows-${{ parameters.arch }}-$tag
  name: image_push
  displayName: Image Push
  retryCountOnTaskFailure: 3

- task: Docker@2
  displayName: Logout
  inputs:
    containerRegistry: $(ACR_SERVICE_CONNECTION)
    command: 'logout'
    addPipelineData: false
