parameters:
- name: name
  type: string
  values:
  - azure-ipam
  - cni
  - cns
  - ipv6-hp-bpf
  - npm

- name: arch
  type: string
  default: ""
  values:
  - amd64
  - arm64

- name: os
  type: string
  default: ""
  values:
  - windows
  - linux

- name: platform
  type: string
  default: ""


steps:
- task: 1ES.BuildContainerImage@1
  retryCountOnTaskFailure: 3
  inputs:
    image: $(IMAGE_NAME_AND_TAG_${{ parameters.name }})
    dockerfile: $(DOCKERFILE_PATH_${{ parameters.name }})
    path: $(Build.SourcesDirectory)
    buildArguments: --platform "${{ parameters.platform }}" --build-arg ARCH="${{ parameters.arch }}" --build-arg OS="${{ parameters.os }}" --build-arg PLATFORM="${{ parameters.platform }}" --build-arg VERSION="$(IMAGE_PLATFORM_TAG_${{ parameters.name }})" --target "${{ parameters.os }}" $(EXTRA_BUILD_ARGS_${{ parameters.name }})
    enableNetwork: true
    enablePull: false
    enableCache: true
    useBuildKit: true

- task: 1ES.PushContainerImage@1
  condition: ${{ eq(parameters.os, 'windows') }}
  inputs:
    image: $(IMAGE_NAME_AND_TAG_${{ parameters.name }})
