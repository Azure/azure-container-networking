parameters:
- name: imageNameAndTag
  type: string

- name: dockerfilePath
  type: string

- name: buildContextPath
  type: string

- name: targetVersion
  type: string

- name: targetArch
  type: string

- name: targetPlatform
  type: string

- name: targetOs
  type: string

- name: addBuildArgs
  type: object
  default: ""


steps:
- task: 1ES.BuildContainerImage@1
  retryCountOnTaskFailure: 3
  inputs:
    image: ${{ parameters.imageNameAndTag }}
    dockerfile: ${{ parameters.dockerfilePath }}
    path: ${{ parameters.buildContextPath }}
    buildArguments: |
      --build-arg DEBUG="$(System.Debug)"
      --build-arg PLATFORM="${{ parameters.targetPlatform }}"
      --build-arg ARCH="${{ parameters.targetArch }}"
      --build-arg OS="${{ parameters.targetOs }}"
      --build-arg VERSION="${{ parameters.targetVersion }}"
      --platform "${{ parameters.targetPlatform }}"
      ${{ parameters.addBuildArgs }}
    enableNetwork: true
    enablePull: true
    enableCache: false
    useBuildKit: true

- task: 1ES.PushContainerImage@1
  condition: ${{ eq(parameters.targetOs, 'windows') }}
  inputs:
    image: ${{ parameters.imageNameAndTag }}
