parameters:
- name: name
  type: string
  values:
  - azure-ipam
  - cni
  - cns
  - ipv6-hp-bpf
  - npm

- name: arch
  type: string
  values:
  - amd64
  - arm64

- name: os
  type: string
  default: ""
  values:
  - windows
  - linux


steps:
- task: 1ES.BuildContainerImage@1
  retryCountOnTaskFailure: 3
  inputs:
    image: $(IMAGE_NAME_AND_TAG_${{ parameters.name }})
    dockerfile: $(DOCKERFILE_PATH_${{ parameters.name }})
    path: $(BUILD_CONTEXT_${{ parameters.name }})
    buildArguments: TARGET=${{ parameters.os }} OS=${{ parameters.os }} PLATFORM=${{ parameters.os }} ARCH=${{ parameters.arch }} $(EXTRA_BUILD_ARGS_${{ parameters.name }})
    enableNetwork: true
    enablePull: false
    enableCache: true
    useBuildKit: true

- task: 1ES.PushContainerImage@1
  condition: ${{ eq(parameters.os, 'windows') }}
  inputs:
    image: $(IMAGE_NAME_AND_TAG_${{ parameters.name }})
