parameters:
  arch: ""
  name: ""
  os: ""

steps:
- task: AzureCLI@2
  displayName: "Login"
  inputs:
    azureSubscription: $(ACR_ARM_SERVICE_CONNECTION)
    scriptLocation: "inlineScript"
    scriptType: "bash"
    inlineScript: |
      az acr login -n $(ACR)

- script: |
    set -e
    echo $(Pipeline.Workspace)
    ls /mnt/
    sudo mkdir -p /mnt
    sudo chown $(whoami):$(whoami) /mnt
    chmod 700 /mnt
    echo "Cloning repository to /mnt/azure-container-networking"
    git clone $(Build.Repository.Uri) /mnt/azure-container-networking
    cd /mnt/azure-container-networking
    git checkout $(Build.SourceVersion)
    echo "Repository cloned to: $(pwd)"
    ls -la
  displayName: "Clone Repository to /mnt"

- script: |
    set -e
    cd /mnt/azure-container-networking
    echo "=== Working directory: $(pwd) ==="
    echo "=== Repository contents ==="
    ls -la
    echo "=== Disk space BEFORE make image ==="
    df -h
    if [ ${{ parameters.os }} = 'windows' ]; then export BUILDX_ACTION='--push'; fi
    make ${{ parameters.name }}-image OS=${{ parameters.os }} ARCH=${{ parameters.arch }} EXTRA_BUILD_ARGS='--driver-opt "storage-opt=source=/mnt/azure-container-networking/"'
    echo "=== Disk space AFTER make image ==="
    df -h
  name: image_build
  displayName: Image Build
  retryCountOnTaskFailure: 2

- task: AzureCLI@2
  displayName: "Logout"
  inputs:
    azureSubscription: $(ACR_ARM_SERVICE_CONNECTION)
    scriptLocation: "inlineScript"
    scriptType: "bash"
    inlineScript: |
      docker logout
