parameters:
  name: ""
  platforms: ""

steps:
- task: onebranch.pipeline.containercontrol@1
  displayName: "Login to ACR"
  inputs:
    command: login
    endpoint: $(ACR_ARM_SERVICE_CONNECTION)

- script: |
    set -e
    make "$IMAGE_NAME"-manifest-build PLATFORMS="$PLATFORMS"
  name: manifest_build
  displayName: Manifest Build
  retryCountOnTaskFailure: 3
  env:
    IMAGE_NAME: '${{ parameters.name }}'
    PLATFORMS: '${{ parameters.platforms }}'

- script: |
    set -ex
    echo "checking XDG_RUNTIME_DIR"
    echo $XDG_RUNTIME_DIR

    make "$IMAGE_NAME"-manifest-push
    mkdir -p "$ARTIFACT_DIR"

    echo "setting XDG_RUNTIME_DIR"
    export XDG_RUNTIME_DIR=/run/user/$(id -u)
    echo $XDG_RUNTIME_DIR

    make "$IMAGE_NAME"-skopeo-archive IMAGE_PUBLISH_DIR="$ARTIFACT_DIR"
  name: manifest_push
  displayName: Manifest Push
  workingDirectory: $(ACN_DIR)
  retryCountOnTaskFailure: 3
  env:
    IMAGE_NAME: '${{ parameters.name }}'
    PLATFORMS: '${{ parameters.platforms }}'
    ARTIFACT_DIR: $(IMAGE_PUBLISH_DIR)

- task: AzureCLI@2
  displayName: "Logout"
  inputs:
    azureSubscription: $(ACR_ARM_SERVICE_CONNECTION)
    scriptLocation: "inlineScript"
    scriptType: "bash"
    inlineScript: |
      docker logout

- task: AzureArtifacts.manifest-generator-task.manifest-generator-task.ManifestGeneratorTask@0
  displayName: "Add SBOM Generator tool"
  inputs:
    BuildDropPath: "$(Build.ArtifactStagingDirectory)"
