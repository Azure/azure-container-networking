parameters:
  name: ""
  platforms: ""
  tag: ""

steps:
  - task: Docker@2
    displayName: Login
    inputs:
      containerRegistry: $(ACR_SERVICE_CONNECTION)
      command: "login"
      addPipelineData: false

  - script: |
      set -e
      export PLATFORMS="${{ parameters.platforms }}"
      export IMAGE=$(make ${{ parameters.name }}-image-name)
      export TAG=${{ parameters.tag }}
      make multiarch-manifest-create PLATFORMS="$PLATFORMS" IMAGE=$IMAGE TAG=$TAG
    name: manifest_build
    displayName: Manifest Build

  - script: |
      set -e
      export IMAGE=$(make ${{ parameters.name }}-image-name)
      export TAG=${{ parameters.tag }}
      make multiarch-manifest-push IMAGE=$IMAGE TAG=$TAG
    name: manifest_push
    displayName: Manifest Push

  - script: | 
      set -e
      export IMAGE=$(make ${{ parameters.name }}-image-name)
      export TAG=${{ parameters.tag }}
      mkdir -p $(Build.ArtifactStagingDirectory)/images
      skopeo copy --all docker://$IMAGE_REGISTRY/$IMAGE:$TAG oci-archive:$(Build.ArtifactStagingDirectory)/images/$IMAGE-$TAG.tar
    name: manifest_archive
    displayName: Manifest Archive

  - task: Docker@2
    displayName: Logout
    inputs:
      containerRegistry: $(ACR_SERVICE_CONNECTION)
      command: "logout"
      addPipelineData: false

  - task: ManifestGeneratorTask@0
    displayName: "Add SBOM Generator tool"
    inputs:
      BuildDropPath: "$(Build.ArtifactStagingDirectory)"

  - task: PublishBuildArtifacts@1
    inputs:
      artifactName: "output"
      pathtoPublish: "$(Build.ArtifactStagingDirectory)"
    condition: succeeded()
