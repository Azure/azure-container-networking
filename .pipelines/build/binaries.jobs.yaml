parameters:
- name: binaries
  type: jobList


jobs:
- ${{ each job_data in parameters.binaries }}:
  - ${{ if eq(job_data.templateContext.action, 'build') }}:
    - job: binaries_${{ job_data.job }}
      displayName: "Build Binary - ${{ job_data.displayName }} -"
      strategy: ${{ job_data.strategy }}
      pool:
        type: linux
        ${{ if eq(job_data.job, 'linux_arm64') }}:
          hostArchitecture: arm64
          vmImage: 'onebranch.azurecr.io/linux/ubuntu-2004-arm64:latest'
        ${{ else }}:
          vmImage: 'onebranch.azurecr.io/linux/ubuntu-2204:latest'

      variables:
        ob_outputDirectory: $(Build.ArtifactStagingDirectory)/out
        ob_artifactSuffix: _$(artifact)
        ob_git_checkout: false
        REPO_ROOT: $(Build.SourcesDirectory)/${{ job_data.templateContext.repositoryArtifact }}
        ${{ if eq(job_data.job, 'linux_amd64') }}:
          ARCH: amd64
          OS: linux
        ${{ elseif eq(job_data.job, 'windows_amd64') }}:
          ob_enable_qemu: true
          ARCH: amd64
          OS: windows
        ${{ elseif eq(job_data.job, 'linux_arm64') }}:
          ob_enable_qemu: true
          ARCH: arm64
          OS: linux
  
      steps:
      - task: DownloadPipelineArtifact@2
        inputs:
          targetPath: $(Build.SourcesDirectory)/${{ job_data.templateContext.repositoryArtifact }}
          artifact: '${{ job_data.templateContext.repositoryArtifact }}'

      - template: binary.steps.yaml
        parameters:
          target: $(name)
          os: $(OS)
          arch: $(ARCH)
