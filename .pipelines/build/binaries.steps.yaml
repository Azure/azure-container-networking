parameters:
- name: target
  type: string
  values:
  - acncli 
  - azure-cni-plugin 
  - azure-cns 
  - azure-npm 
  - azure-ipam 
  - ipv6-hp-bpf


steps:
- task: GoTool@0
  inputs:
    version: '$(GOVERSION)'

- bash: |
    make ipv6-hp-bpf-lib
    make "$TARGET"
  displayName: "Build all platform binaries"
  workingDirectory: $(ACN_DIR)
  env:
    TARGET: ${{ parameters.target }}

- script: |
    mkdir -p ./out/bins
    cd ./out
    find . -name '*.tgz' -print -exec mv -t ./bins/ {} +
    find . -name '*.zip' -print -exec mv -t ./bins/ {} +
    shopt -s extglob
    rm -rf !("bins")
  displayName: "Prepare Artifacts"
  workingDirectory: $(ACN_DIR)

- task: CopyFiles@2
  inputs:
    sourceFolder: "$(ACN_DIR)/out"
    targetFolder: $(Build.ArtifactStagingDirectory)/out
