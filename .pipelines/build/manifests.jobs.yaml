parameters:
- name: generate
  type: jobList


jobs:
- ${{ for job in parameters.generate }}:
  - job: ${{ job.name }}_generate_manifest
    displayName: "Generate Image Manifest - ${{ job.name }}"
    pool:
      type: linux
    variables:
      ob_outputDirectory: $(Build.SourcesDirectory)/out
      ob_git_checkout: false
    steps:
    - template: /.pipelines/build/generate-manifest.steps.yaml
      parameters:
        platforms: ${{ job.templateContext.platforms }}

  - job: ${{ job.name }}_publish_manifest
    displayName: "Publish Image Manifest - ${{ job.name }}"
    dependsOn:
    - ${{ job.name }}_generate_manifest
    pool:
      type: docker
    variables:
      ob_outputDirectory: $(Build.SourcesDirectory)/out
      ob_git_checkout: false
    steps:
    - template: /.pipelines/build/publish-manifest.steps.yaml
      parameters:
        image_repository: $(IMAGE_REPO_PATH)/${{ job.templateContext.name }}
        image_tag: ${{ job.templateContext.image_tag }}
        manifest_data: $[ dependencies.${{ job.name }}_generate_manifest.outputs['data.MANIFEST'] ]
