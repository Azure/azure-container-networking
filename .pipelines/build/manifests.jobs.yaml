parameters:
- name: generate
  type: jobList


jobs:
- ${{ for manifest_job in parameters.generate }}:
  - job: ${{ manifest_job.job }}_generate_manifest
    displayName: "Generate Image Manifest - ${{ manifest_job.job }}"
    pool:
      type: linux
    variables:
      ob_outputDirectory: $(Build.SourcesDirectory)/out
      ob_git_checkout: false
    steps:
    - template: /.pipelines/build/generate-manifest.steps.yaml
      parameters:
        platforms: ${{ manifest_job.templateContext.platforms }}

  - job: ${{ manifest_job.job }}_publish_manifest
    displayName: "Publish Image Manifest - ${{ manifest_job.job }}"
    dependsOn:
    - ${{ manifest_job.job }}_generate_manifest
    pool:
      type: docker
    variables:
      ob_outputDirectory: $(Build.SourcesDirectory)/out
      ob_git_checkout: false
    steps:
    - template: /.pipelines/build/publish-manifest.steps.yaml
      parameters:
        image_repository: $(IMAGE_REPO_PATH)/${{ manifest_job.templateContext.name }}
        image_tag: ${{ manifest_job.templateContext.image_tag }}
        manifest_data: $[ dependencies.${{ manifest_job.job }}_generate_manifest.outputs['data.MANIFEST'] ]
