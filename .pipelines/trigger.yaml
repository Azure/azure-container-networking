pr:
  branches:
    include:
      - master
      - release/*
  paths:
    exclude:
      - ".devcontainer"
      - ".hooks"
      - ".vscode"
      - ".github"
      - docs


trigger:
  branches:
    include:
      - gh-readonly-queue/master/*
  tags:
    include:
      - "*"

resources:
  repositories:

  - repository: 1ESPipelineTemplates
    type: git
    name: 1ESPipelineTemplates/1ESPipelineTemplates
    ref: refs/tags/stable

  - repository: azure-container-networking
    type: github
    name: Azure/azure-container-networking
    endpoint: 'Azure-ACN RO Service Connection'
    ref: refs/heads/feature/ob-onboard-2


variables:
  REPO_REF: $[ resources.repositories['azure-container-networking'].ref ]
  REPO_COMMIT: $[ resources.repositories['azure-container-networking'].version ]
  REPO_NAME: $[ resources.repositories['azure-container-networking'].name ]
  REPO_TYPE: $[ resources.repositories['azure-container-networking'].type ]
  CHANGESET_COMMIT: $[ resources.repositories['self'].version ]
  # Local analysis is only enabled on PR branches
  Codeql.AnalyzeInPipeline: $[startsWith(variables['Build.SourceBranch'], 'refs/pull/')]

extends:
  template: v1/1ES.Unofficial.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    pool:
      name: $(BUILD_POOL_NAME_DEFAULT)
      os: linux
      image: acn-runner-vmss-image-1es-v3.0
    authenticatedContainerRegistries:
    - serviceConnection: $(ACR_ARM_SERVICE_CONNECTION)
    - registry: onebranch.azurecr.io
      tenant: AME
      identity: 1ESPipelineIdentity
    containers:
      default_windows_container:
        image: onebranch.azurecr.io/windows/ltsc2019/vse2022:latest
      default_linux_container:
        image: onebranch.azurecr.io/linux/ubuntu-2204:latest
    sdl:
      sourceAnalysisPool: 
        name: $(BUILD_POOL_NAME_DEFAULT_WINDOWS)
        os: windows
        image: acn-runner-vmss-image-windows-1es-v2.0
      codeql:
        # Enables CodeQL on the main branch
        compiled:
          enabled: true
          # Enables CodeQL on PR branches
          ${{ if startsWith(variables['Build.SourceBranch'], 'refs/pull/') }}:
            enabledOnNonDefaultBranches: true
    stages:
    - template: /.pipelines/run-pipeline.yaml@azure-container-networking
