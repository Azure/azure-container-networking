################################
#### UBUNTU PACKAGE MANAGER ####
################################
# Description:
# Implementation of the package manager operations for ubuntu systems.

parameters:
## Public Parameters

# Inherited.
- name: operationName
  type: string
# Inherited.
- name: packageName
  type: string
  default: ''
# Inherited.
- name: cmdopts
  type: string
  default: ''


## Private Parameters

# The operations supported by this module.
# You can extend this list in order to create package manager specific
# operations. Implement these operations below.
- name: extendedOperations
  type: object
  default: []


steps:
## Update
##
## The package manager update command.
## Updates the system package manager cache.
- ${{ if eq(parameters.operationName, 'update') }}:
  - bash: |
      set -e
      [[ -n $(which sudo) ]] && ELEV='sudo '
      CMD=$(printf '%s%s' "$ELEV" "apt-get update -y")
      echo >&2 "##[command]sudo apt-get update -y"
      sudo apt-get update -y
    displayName: 'Update Package Cache (apt-get)'


## Upgrade
##
## The package manager upgrade command.
## If the package name is given, then the command will attempt to upgrade _only_
## the given package. 
## If no package name is given, then the command will perform a system package
## upgrade.
- ${{ elseif eq(parameters.operationName, 'upgrade') }}:
  - ${{ if ne(parameters.packageName, '') }}:
    - bash: |
        set -e
        ELEV=
        [[ -n $(which sudo) ]] && ELEV='sudo '
        CMD=$(printf '%s%s %s %s' "$ELEV" "apt-get install -y --upgrade-only" "$PKG" "$OPTS")
        echo >&2 "##[command]"$CMD""
        $CMD
        sudo apt-get update -y
      displayName: 'Upgrading System Packages (apt-get)'
      env:
        PKG: '${{ parameters.packageName }}'
        OPTS: '${{ parameters.pkgopts }}'
  
  - ${{ else }}:
    - bash: |
        set -e
        ELEV=
        [[ -n $(which sudo) ]] && ELEV='sudo '
        CMD=$(printf '%s%s %s' "$ELEV" "apt-get install -y --upgrade-only" "$OPTS")
        echo >&2 "##[command]"$CMD""
        $CMD
        sudo apt-get update -y
      displayName: 'Upgrading System Packages (apt-get)'
      env:
        OPTS: '${{ parameters.pkgopts }}'


## Install
##
## The package manager install command.
## Installs the package given by packageName parameter.
- ${{ elseif eq(parameters.operationName, 'install') }}:
  - bash: |
      set -e
      ELEV=
      [[ -n $(which sudo) ]] && ELEV='sudo '
      CMD=$(printf '%s%s %s %s' "$ELEV" "apt-get install -y" "$PKG" "$OPTS")
      echo >&2 "##[command]"$CMD""
      $CMD
    displayName: 'Installing Package (apt-get:${{ parameters.packageName }})'
    env:
      PKG: '${{ parameters.packageName }}'
      OPTS: '${{ parameters.pkgopts }}'


## Remove
##
## The package manager install command.
## Installs the package given by packageName parameter.
- ${{ elseif eq(parameters.operationName, 'remove') }}:
  - bash: |
      set -e
      CMD=$(printf '%s%s %s %s' "$ELEV" "apt-get remove -y" "$PKG" "$OPTS")
      echo >&2 "##[command]"$CMD""
      $CMD
    displayName: 'Removing Package (apt-get:${{ parameters.packageName }})'
    env:
      PKG: '${{ parameters.packageName }}'
      OPTS: '${{ parameters.pkgopts }}'


##- ${{ elseif containsValue(parameters.extendedOperations, parameters.operationName) }}:
  # Add Other Operation Implementations Here.


## Operation Not Implemented Catch
- ${{ else }}:
  - bash: |
      echo >&2 "This operation is not implemented for this package manager."
    displayName: 'Operation Not Implemented (apt-get:${{ parameters.operationName }})'
