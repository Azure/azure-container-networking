#
#apt-get update && apt install -yf \
#    binfmt-support \
#    build-essential \
#    clang \
#    cmake \
#    dirmngr \
#    ebtables \
#    gcc \
#    gdb \
#    iproute2 \
#    ipset \
#    iptables \
#    libboost-dev \
#    libboost-thread-dev \
#    libssl-dev \
#    qemu-user-static \
#    zip \
#    zlib1g-dev \
#	slirp4netns \
#	fuse-overlayfs \
#	mono-complete \
#    mono-runtime

##############
#### Tool ####
##############
parameters:
# List of supported tools in this task.
- name: tool
  type: string

# Operating Systems to Support
# for each tool.
- name: os
  type: string
  values:
  - windows
  - mariner
  - ubuntu
# Usually just the package name.
# In some cases you may want to provide extra args
# Hence "installCmd"
- name: installCmd
  type: string
# Should we print the version?
- name: printVersion
  type: boolean
  default: false
# Cmd for printing the version for this tool.
- name: versionCmd
  type: string
  default: ''
# Steps to execute postInstall
- name: postInstall
  type: stepList
  default: []


steps:
- bash: |
    set -e
    CMD=$(printf '%s %s' "$PKG_MGR_INSTALL_CMD" "$PKG")
    $CMD

    [[ $PRINT_VERSION =~ [T|t]rue ]] && \
      echo >&2 "[command]"$CMD"" && \
      $CMD || echo >&2 "Skipping version print."
  displayName: 'Installing Package (${{ parameters.tool }})'
  env:
    PKG: '${{ parameters.installCmd }}'
    PRINT_VERSION: '${{ parameters.printVersion }}'
    VERSION_CMD: '${{ parameters.versionCmd }}'
    ${{ if eq(parameters.os, 'mariner') }}:
      PKG_MGR_INSTALL_CMD: 'sudo tdnf install -y'
    ${{ elseif eq(parameters.os, 'ubuntu') }}:
      PKG_MGR_INSTALL_CMD: 'sudo apt-get install -y'

- ${{ each step in parameters.afterInstall }}:
  - ${{ step }}

- bash: |
    set -e
    $PKG_MGR_UPGRADE_CMD
  displayName: 'Upgrade Installed Packages'
  env:
    ${{ if eq(parameters.os, 'mariner') }}:
      PKG_MGR_UPGRADE_CMD: 'sudo tdnf upgrade -y'
    ${{ elseif eq(parameters.os, 'ubuntu') }}:
      PKG_MGR_UPGRADE_CMD: 'sudo apt-get upgrade -y'
