parameters:
- name: install
  type: object
  default: []

- name: os
  type: string
  values:
  - mariner
  - ubuntu
  - windows

steps:
# Update Package Manager Cache
- ${{ if eq(parameters.os, 'mariner') }}:
  - bash: |
      set -e
      sudo tdnf -y update
    displayName: 'Update Package Cache'

- ${{ elseif eq(parameters.os, 'ubuntu') }}:
  - bash: |
      set -e
      sudo apt-get -y update
    displayName: 'Update Package Cache'

- ${{ else }}:
  - bash: |
      echo "Skipping Cache Update."
    displayName: 'Skipping Cache Update'


# Install  selected tooling
- ${{ each tool in parameters.install }}:
  - ${{ if eq(tool, 'kubectl') }}:
    # Install Kubectl
    - task: KubectlInstaller@0
      displayName: 'Install Kubectl'
      inputs:
        kubectlVersion: latest

  # Install Golang
  - ${{ elseif eq(tool, 'golang') }}:
    - task: GoTool@0
      displayName: 'Install Golang (1.22.5)'
      inputs:
        version: '1.22.5'

  # Install Docker
  - ${{ elseif eq(tool, 'docker') }}:

    - ${{ if eq(parameters.os, 'mariner') }}: # Docker Install for Mariner
      - bash: |
          sudo tdnf remove -y \
            docker \
            docker-client \
            docker-client-latest \
            docker-common \
            docker-latest \
            docker-latest-logrotate \
            docker-logrotate \
            docker-selinux \
            docker-engine-selinux \
            docker-engine
  
          set -e
          sudo tdnf install -y ca-certificates \
            moby-engine \
            moby-cli \
            moby-buildx \
            moby-compose
        displayName: 'Install Docker'

    - ${{ elseif eq(parameters.os, 'ubuntu') }}: # Docker Install for Ubuntu
      - bash: |
          sudo apt-get remove -y \
            docker.io \
            docker-doc \
            docker-compose \
            docker-compose-v2 \
            podman-docker \
            containerd \
            runc
  
          set -e
          sudo apt-get install -y ca-certificates curl
            docker-ce \
            docker-ce-cli \
            containerd.io \
            docker-buildx-plugin \
            docker-compose-plugin
        displayName: 'Install Docker'

  - ${{ else }}: # Install non-complex tooling
      # Simple Misc Tool Installation
    - template: template.install-tool.steps.yaml
      parameters:
        tool: ${{ tool }}
        os: ${{ parameters.os }}
        # There is no difference in handling between pkg managers
        # so we do not yet make that distinction now.
        ${{ if eq(tool, 'lsof') }}:
          pkgName: 'lsof'
          pkgCli: 'lsof'
          hasVersion: true
          versionCmd: '-v'
        ${{ elseif eq(tool, 'buildah') }}:
          pkgName: 'buildah'
          pkgCli: 'buildah'
          hasVersion: true
          versionCmd: 'version'
        ${{ elseif eq(tool, 'podman') }}:
          pkgName: 'podman'
          pkgCli: 'podman'
          hasVersion: true
          versionCmd: 'version'
        ${{ elseif eq(tool, 'skopeo') }}:
          pkgName: 'skopeo'
          pkgCli: 'skopeo'
          hasVersion: true
          versionCmd: '--version'
        ${{ elseif eq(tool, 'containers-common') }}:
          pkgName: 'containers-common'
