
steps:
# Based off of https://github.com/containers/image_build/blob/main/podman/Containerfile
- bash: |
    PODMAN_USER=podman
    sudo useradd --create-home "$PODMAN_USER"
    echo -e "podman:1:999\npodman:1001:64535" > /etc/subuid
    echo -e "podman:1:999\npodman:1001:64535" > /etc/subgid
    
    cp podman-containers.conf /home/"$PODMAN_USER"/.config/containers/containers.config
    
    #mkdir -p /home/"$PODMAN_USER"/.local/share/containers
    #    chown podman:podman -R /home/"$PODMAN_USER"
    # Assign ownership to user
    #chmod 644 /etc/containers/containers.conf
    
    # Copy & modify the defaults to provide reference if runtime changes needed.
    # Changes here are required for running with fuse-overlay storage inside container.
    #sed -e 's|^#mount_program|mount_program|g' \
        #-e '/additionalimage.*/a "/var/lib/shared",' \
        #-e 's|^mountopt[[:space:]]*=.*$|mountopt = "nodev,fsync=0"|g' \
        #/usr/share/containers/storage.conf > /etc/containers/storage.conf
    
    # Setup internal Podman to pass subscriptions down from host to internal container
    printf '/run/secrets/etc-pki-entitlement:/run/secrets/etc-pki-entitlement\n/run/secrets/rhsm:/run/secrets/rhsm\n' > /etc/containers/mounts.conf
    
    # Note VOLUME options must always happen after the chown call above
    # RUN commands can not modify existing volumes
    mkdir -p /var/lib/shared/overlay-images \
             /var/lib/shared/overlay-layers \
             /var/lib/shared/vfs-images \
             /var/lib/shared/vfs-layers
    touch /var/lib/shared/overlay-images/images.lock
    touch /var/lib/shared/overlay-layers/layers.lock
    touch /var/lib/shared/vfs-images/images.lock
    touch /var/lib/shared/vfs-layers/layers.lock
    
    # Allow Build Env to take advantage of variable exports
    echo >&2 "##vso[task.setvariable variable=_CONTAINERS_USERNS_CONFIGURED]"""
    echo >&2 "##vso[task.setvariable variable=BUILDAH_ISOLATION]chroot"
