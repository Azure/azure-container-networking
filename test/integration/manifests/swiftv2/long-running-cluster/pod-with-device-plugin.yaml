apiVersion: v1
kind: Pod
metadata:
  name: {{ .PodName }}
  namespace: {{ .Namespace }}
  labels:
    kubernetes.azure.com/pod-network-instance: {{ .PNIName }}
    kubernetes.azure.com/pod-network: {{ .PNName }}
spec:
  containers:
  - name: net-debugger
    image: {{ .Image }}
    command: ["/bin/bash", "-c"]
    args:
      - |
        echo "Pod Network Diagnostics started on $(hostname)";
        echo "Node: $(hostname)";
        echo "Pod IP: $(hostname -i)";
        echo "Starting HTTP server on port 8080";
        
        # Create a simple HTTP server directory
        mkdir -p /tmp/www
        cat > /tmp/www/index.html <<'EOF'
        <!DOCTYPE html>
        <html>
        <head><title>Network Test Pod - Auto Scheduled</title></head>
        <body>
        <h1>Pod Network Test with Device Plugin (Auto-Scheduled)</h1>
        <p><strong>Hostname:</strong> $(hostname)</p>
        <p><strong>IP Address:</strong> $(hostname -i)</p>
        <p><strong>Timestamp:</strong> $(date)</p>
        </body>
        </html>
        EOF
        
        # Start Python HTTP server on port 8080 in background
        cd /tmp/www && python3 -m http.server 8080 &
        HTTP_PID=$!
        echo "HTTP server started with PID $HTTP_PID on port 8080"
        
        # Give server a moment to start
        sleep 2
        
        # Verify server is running
        if netstat -tuln | grep -q ':8080'; then
          echo "HTTP server is listening on port 8080"
        else
          echo "WARNING: HTTP server may not be listening on port 8080"
        fi
        
        # Keep showing network info periodically
        while true; do
          echo "=== Network Status at $(date) ==="
          ip addr show
          ip route show
          echo "=== Listening ports ==="
          netstat -tuln | grep LISTEN || ss -tuln | grep LISTEN
          sleep 300  # Every 5 minutes
        done
    ports:
    - containerPort: 8080
      protocol: TCP
    resources:
      limits:
        cpu: 300m
        memory: 600Mi
        acn.azure.com/vnet-nic: "1"
      requests:
        cpu: 300m
        memory: 600Mi
        acn.azure.com/vnet-nic: "1"
    securityContext:
      privileged: true
  restartPolicy: Always
