apiVersion: v1
kind: Pod
metadata:
  name: {{ .PodName }}
  namespace: {{ .Namespace }}
  labels:
    kubernetes.azure.com/pod-network-instance: {{ .PNIName }}
    kubernetes.azure.com/pod-network: {{ .PNName }}
spec:
  nodeSelector:
    kubernetes.io/hostname: {{ .NodeName }}
  containers:
  - name: net-debugger
    image: {{ .Image }}
    command: ["/bin/bash", "-c"]
    args:
      - |
        echo "Pod Network Diagnostics started on $(hostname)"
        echo "Pod IP: $(hostname -i)"
        echo "Starting TCP listener on port 8080"
        
        # Start netcat listener that responds to connections
        while true; do 
          echo "TCP Connection Success from $(hostname) at $(date)" | nc -l -p 8080
        done
        echo "Pod Network Diagnostics started on $(hostname)";
        echo "Pod IP: $(hostname -i)";
        echo "Starting TCP listener on port 8080";
        
        while true; do 
          nc -l -p 8080 -c 'echo "TCP Connection Success from $(hostname) at $(date)"'
        done &
        
        echo "TCP listener started on port 8080"
        sleep 2
        if netstat -tuln | grep -q ':8080'; then    # Verify listener is running
          echo "TCP listener is active on port 8080"
        else
          echo "WARNING: TCP listener may not be active on port 8080"
        fi
    ports:
    - containerPort: 8080
      protocol: TCP
    resources:
      limits:
        cpu: 300m
        memory: 600Mi
      requests:
        cpu: 300m
        memory: 600Mi
    securityContext:
      privileged: true
  restartPolicy: Always
