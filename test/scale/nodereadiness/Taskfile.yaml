version: "3"

tasks:
  setup:
    desc: Setup cluster.
    cmds:
      - kubectl apply -f ./files/nncscale_rbac.yaml
      - kubectl apply -f ./files/nncscale_pod.yaml
      - kubectl apply -f ./files/prom_rbac.yaml
      - kubectl apply -f ./files/prom-deployment.yaml
  kwok:
    desc: Start Kwok
    cmds:
      - ./skale kwok --cidr=155.0.0.0/16 --node-ip=155.0.0.1 --manage-all-nodes=false --manage-nodes-with-annotation-selector=kwok.x-k8s.io/node=fake --manage-nodes-with-label-selector=
  skale-*:
    desc: Scale the Kwok nodes.
    vars:
      SUBNETGUID: "cf649a07-6690-41ff-b9ef-a5be9582de4f"
      NODES: '{{index .MATCH 0}}'
    cmds:
      # - ./scripts/test-and-result.sh {{.NODES}} {{.SUBNETGUID}}
      - ./skale --nodes {{.NODES}} --subnet "pod-subnet" --subnet-guid {{.SUBNETGUID}}
      # Save Prometheus snapshot.
  scaledown:
    desc: Scale down the Kwok nodes.
    cmds:
      - kubectl delete nodes -l type=kwok
  prom:
    desc: View results.
    cmds:
      - kubectl port-forward svc/prometheus 9092:9090
  graf:
    desc: Local Grafana.
    cmds:
      - sudo systemctl daemon-reload
      - sudo systemctl start grafana-server
  teardown:
    desc: Teardown components.
    cmds:
      - kubectl delete -f ./files/nncscale_rbac.yaml
      - kubectl delete -f ./files/nncscale_pod.yaml
      - kubectl delete -f ./files/prom-deployment.yaml
      - kubectl delete nodes -l type=kwok
      # TODO: Delete kwok nodes with skale?