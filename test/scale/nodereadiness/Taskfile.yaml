version: "3"

tasks:
  setup:
    desc: Setup cluster.
    cmds:
      - kubectl apply -f ./files/nncscale_rbac.yaml
      - kubectl apply -f ./files/nncscale_pod.yaml
      - kubectl apply -f ./files/prom_rbac.yaml
      - kubectl apply -f ./files/prom-deployment.yaml
  kwok:
    desc: Start Kwok
    cmds:
      - ./skale kwok --cidr=155.0.0.0/16 --node-ip=155.0.0.1 --manage-all-nodes=false --manage-nodes-with-annotation-selector=kwok.x-k8s.io/node=fake --manage-nodes-with-label-selector=
  skale:
    desc: Scale the Kwok nodes.
    cmds:
      - ./skale --nodes {{.CLI_ARGS}} --subnet "pod-subnet" --subnet-guid {{.SUBNETGUID}}
      # Save Prometheus snapshot.
    vars:
      SUBNETGUID: "cf649a07-6690-41ff-b9ef-a5be9582de4f"
  scaledown:
    desc: Scale down the Kwok nodes.
    cmds:
      - kubectl delete nodes -l type=kwok
  prom:
    desc: View results.
    cmds:
      - kubectl port-forward svc/prometheus 9092:9090
      # k port-forward services/grafana 3000:3000
      # Configure Grafana dashboard with Prometheus source

      # TODO: save + auto snapshot?
  teardown:
    desc: Teardown components.
    cmds:
      - kubectl delete -f ./files/nncscale_rbac.yaml
      - kubectl delete -f ./files/nncscale_pod.yaml
      - kubectl delete -f ./files/prom-deployment.yaml
      - kubectl delete nodes -l type=kwok
      # TODO: Delete kwok nodes with skale?